ASMB,L,C
      HED VIDEO CHARACTER GENERATOR SUBROUTINE     A-91200-16002-2
* 
*     NAME:   CHARACTER GENERATOR OF VIDEO DISPLAY LIBRARY
*     SOURCE: 91200-18002 (FILE 3)
*     BINARY: 91200-16002 (MODULE 3)
*     PGMR:   R.M.C. REV.C(1648) MADE BY DENTON ANDERSON
*               REV.B(1603) IS FOR COLOR OPERATION. 
*               REV.C(1648) IS FOR POWER FAIL - AUTO RESTART. 
* 
      NAM CHAR,7 91200-16002 REV 1648 -- 761124 
      ENT CHAR,CH#R 
      EXT .ENTR,DI[T,[TAB,VECTR 
      SUP PRESS EXTRANEOUS LISTING
      SPC 1 
XCHAR NOP           "X" COORDINATE, LOWER LEFT POINT. 
YCHAR NOP           "Y" COORDINATE, LOWER LEFT POINT. 
BUFAD NOP           BEGINNING OF CHARACTER STRING.
SIZE  DEF ZERO      CHARACTER SIZE (>0).
ROT   DEF ZERO      90 DEGREE ROTATION (0:3). 
LEN   DEF ZERO      STRING LENGTH PARAMETER.
MODE  DEF ZERO      0 TO WRITE, NON-0 TO ERASE. 
PFL   NOP           POWER FAIL INDICATOR. 
      SPC 1 
CHAR  NOP           ENTRY POINT.
      JSB .ENTR     TRANSFER THE PARAMETER ADDRESSES. 
       DEF XCHAR
      LDA ROT,I 
      AND B3        MOD 4 
      STA ROT 
      LDA PFL       TRANSFER POWER FAIL INDICATOR 
      STA PFAIL       ADDRESS FOR NEXT CALL.
      LDA YCHAR,I   RETRIEVE INITIAL Y AND
      STA YV        X CO-ORDINATES FOR TRANSFER 
      LDA XCHAR,I   TO 'VECTR' SUBROUTINE.
      STA XV
      LDA SIZE,I    LOAD THE CHARACTER SIZE.
      SSA           IS THE CHARACTER SIZE NEGATIVE? 
      JMP EXIT      ERROR, RETURN; "CALL" REJECTED. 
      SZA,RSS       IF SIZE 0 OR DEFAULTED, 
      CLA,INA       SET TO SIZE 1 
      AND B77       LIMIT TO A REASONABLE VALUE.
      STA SIZE
      CCA 
      STA PCT       PRESET THE PARENS COUNT,
      STA CHCTR     AND CHARACTER COUNT.
      LDA LEN,I 
      SSA           STRING DELIMITED BY PARENS
      JMP BYTAD     WHEN LEN IS NEGATIVE..
      SZA,RSS       STRING LENGTH IN FIRST WORD 
      LDA BUFAD,I   WHEN LEN=0. 
      AND B77       REMOVE POSS HIGH CHAR.
      STA PCT       PROTECT AGAINST ALL ('S.
      CMA           USUAL INA SUPPRESSED TO ALLOW 
      STA CHCTR     LATER TEST WITH ISZ.
      SKP 
      LDA LEN,I 
      SZA,RSS       TEST AGAIN FOR 0 PARAMETER
      ISZ BUFAD     & BUMP TO PASS OVER.
      SPC 1 
BYTAD LDA BUFAD 
      CLE,ELA       FORM BYTE ADDRESS.
      STA BUFAD 
      ISZ CHCTR     SKIPS IF PARENS MODE
      RSS           CHCTR IS SAFE, & INITIALLY, 
NCH   ISZ BUFAD     INCREMENT FOR THE NEXT CHARACTER. 
      LDA BUFAD     LOAD THE ADDRESS WORD.
      CLE,ERA       SAVE BIT 0 IN "E"; SHIFT ADDRESS. 
      LDA A,I       GET THE CHARACTER WORD. 
      SEZ,RSS       IS THE CHARACTER IN BITS 15-8?
      ALF,ALF       YES, SO SHIFT IT INTO BITS 7-0. 
      LDB DI[T      DICTIONARY PARAMETERS ADDRESS 
      AND B,I       MASK TO LOWER BYTE (7 OR 8
      INB            BITS AS DEFINED IN DICTIONARY).
      ADA B,I       SUBTRACT BASE CODE OF TABLE.
      SSA           IF THE CHAR CODE IS < THE BASE, 
      JMP NCH       IGNORE THIS CHARACTER.
      INB           POINT TO TABLE LENGTH.
      ADA B,I       IF THE CHARACTER IS STILL NOT 
      SSA,RSS        IN THE TABLE,THEN  TRY TO
      ADA M40         FORCE LOWER CASE TO UPPER CASE. 
      SSA,RSS       IF STILL NOT IN THE TABLE,
      JMP NCH        IGNORE THE CHARACTER.
      CMA,INA       RESTORE DICTIONARY OFFSET IN
      ADA B,I       A ROUND-ABOUT WAY 
      CMA,INA 
      CPA LPARC     IS THIS CHARACTER A "("?
      JMP LPARN     YES.
      CPA RPARC     IS THIS CHARACTER A ")"?
      ISZ PCT       YES.  IS IT THE FINAL ONE?
      JMP D         NO, CONTINUE. 
      JMP EXIT      YES, FINAL ")" SO RETURN. 
      SPC 1 
B3    OCT 3 
B7    OCT 7 
B17   OCT 17
B77   OCT 77
B777  OCT 777 
M1    OCT -1
M40   OCT -40 
LPARC ABS 50B-40B   ( 
P     NOP 
PCT   NOP           PARENTHESIS COUNTER.
RPARC ABS 51B-40B   ) 
      SKP 
LPARN LDA PCT       LOAD THE PARENTHESIS COUNTER. 
      ADA M1        DECREMENT BY ONE(1).
      STA PCT       STORE IT IN "PCT".
      LDA LPARC     GET LPAREN CODE AGAIN 
D     INB           START OF DICTIONARY 
      ADA B 
      LDB A         TEMP SAVE OF DICTIONARY ADDRESS.
      LDA B,I       DICTIONARY CHARACTER CODE WORD. 
      ALF           NUMBER OF CONTROL WORDS TO 4 LSB. 
      AND B17       MASK OFF BITS 3-0.
      CMA,INA       NEGATE FOR COUNTING.
      CLE,ELA       FORM THE BYTE COUNT.
      STA CCT       PRESET TO -(# OF VECTORS).
      LDA B,I       GET THE DICTIONARY WORD AGAIN.
      AND B777      MASK OFF THE RELATIVE ADDRESS.
      LDB [TAB      ADD BEGINNING OF TABLE ADDRESS. 
      ADA B 
      CLE,ELA       FORM THE BYTE ADDRESS 
      STA P         SAVE "A" AT "P".
NCW   LDB P         CHARACTER ADDRESS OF COMMAND. 
      ISZ P         INCREMENT "P" FOR THE NEXT CODE.
      CLE,ERB       FORM MEMORY ADDRESS OF COMMAND. 
      LDB B,I       LOAD THE WORD CONTAINING COMMAND. 
      SEZ           TEST THE COMMAND LOCATION.
      BLF,BLF       SHIFT COMMAND TO BITS 15-8. 
      RBL,RBL 
      STB A 
      AND B3        ORIGINAL CODE BITS 6,7
      STA TYPE
      BLF,RBR 
      STB A 
      AND B7        ORIGINAL CODE BITS 3,4,5
      ADA ROT       CORRECT FOR STRING'S ROTATION 
      ADA ROT 
      AND B7        MAKE MOD 8
      STA THETA 
      BLF,RBR 
      STB A 
      AND B7        ORIGINAL CODE BITS 0,1,2
      MPY SIZE
      STA VLEN
      JSB VOUT
      CCA           SET XV NEGATIVE SO THAT NEXT
      STA XV        VECTOR WILL BE APPENDED.
      ISZ CCT       MORE COMMAND WORDS? 
      JMP NCW       GET EM. 
      ISZ CHCTR     MORE CHARACTERS?
      JMP NCH       GET EM. 
      SKP 
EXIT  LDA B100K     DO A COMPLETION CALL TO 
      STA VLEN      VECTOR. 
      JSB VOUT
      LDA DZERO     RESTORE DEFAULT PARAMETERS
      STA SIZE      FOR NEXT ENTRY
      STA ROT 
      STA VLEN
      STA MODE
      CLA 
      STA PFL 
      JMP CHAR,I
      SPC 1 
VOUT  NOP 
      JSB VECTR 
       DEF CHK
       DEF XV 
       DEF YV 
       DEF THETA
       DEF VLEN 
       DEF TYPE 
       DEF MODE,I 
       DEF ZERO 
PFAIL  NOP
CHK   JMP VOUT,I
      SPC 3 
CCT   NOP           CODE COUNTER. 
ZERO  OCT 0 
B100K OCT 100000
DZERO DEF ZERO
      SPC 1 
CHCTR NOP           CHARACTER COUNT 
THETA NOP           VECTOR ROTATION 0:7 
TYPE  NOP           VECTOR CONTROL 'WORD' 
*                                    0 NON-WRITING
*                                    1 SUPPRESS FIRST POINT 
*                                    2 WRITE ALL POINTS 
*                                    3 SUPPRESS FIRST & LAST POINTS.
      SPC 1 
A     EQU 0 
B     EQU 1 
CH#R  EQU CHAR
XV    EQU XCHAR 
YV    EQU YCHAR 
VLEN  EQU LEN 
      SPC 2 
      END 
